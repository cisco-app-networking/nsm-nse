node {
    environment{
        CGO_ENABLED = 0
        GO111MODULE = on
    }
    docker.image('debian').withRun('-v /var/run/docker.sock:/var/run/docker.sock') {
        stage ('Install Dependencies') {
            sh "sudo apt-get update && sudo apt-get install -y docker-ce"
        }
        stage ('Install Golang') {
            sh "wget https://storage.googleapis.com/golang/go1.15.6.linux-amd64.tar.gz"
            sh "sudo tar -C /usr/local -xzf go1.15.6.linux-amd64.tar.gz"
        }
        stage ('Checkout SCM') {
            checkout scm
        }
        stage ('Test: VPP Agent End-to-End Test') {
            withEnv(["GOPATH=${env.WORKSPACE}/go", "GOROOT=/usr/local/go", "PATH+GO=/usr/local/go/bin"]){
                sh "./test/e2e/run_e2e.sh"
            }
        }
        stage ('Clean Up') {
            deleteDir()
        }
    }
}

